<?php
header('Content-Type: application/json');
/* 
-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----


*/

//dsds
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['profile_picture'])) {
    $file = $_FILES['profile_picture'];
    $uploadDir = '../uploads/profile_pictures/';
    
    if (!file_exists($uploadDir)) {
        mkdir($uploadDir, 0777, true);
    }

    
    $fileExt = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
    $allowedExts = ['jpg', 'jpeg', 'png'];
    
    if (!in_array($fileExt, $allowedExts)) {
        echo json_encode(['success' => false, 'error' => 'Invalid file type. Only JPG and PNG allowed.']);
        exit;
    }
    
    $newFileName = uniqid('profile_', true) . '.' . $fileExt;
    $filePath = $uploadDir . $newFileName;
    
    try {
        $imagick = new Imagick($file['tmp_name']);
        $imagick->setImageFormat('jpeg');
        
        // Resize and crop to square
        $dimensions = min($imagick->getImageWidth(), $imagick->getImageHeight());
        $imagick->cropImage($dimensions, $dimensions, 0, 0);
        $imagick->resizeImage(200, 200, Imagick::FILTER_LANCZOS, 1);
        
        // Reduce quality
        $imagick->setImageCompression(Imagick::COMPRESSION_JPEG);
        $imagick->setImageCompressionQuality(80);
        
        $imagick->writeImage($filePath);
        $imagick->clear();
        $imagick->destroy();
        
        echo json_encode(['success' => true, 'file_url' => $filePath]);
    } catch (Exception $e) {
        echo json_encode(['success' => false, 'error' => 'Image processing failed.']);
    }
} else {
    echo json_encode(['success' => false, 'error' => 'No file uploaded.']);
}
